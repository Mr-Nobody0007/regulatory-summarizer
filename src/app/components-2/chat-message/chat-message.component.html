<div class="message-container" [ngClass]="{'user-message': message.isUser, 'system-message': !message.isUser}">
  <!-- User Message Bubble -->
  <div *ngIf="message.isUser" class="message-bubble user-bubble">
    <div class="message-content">
      {{ message.content }}
    </div>
    <div class="message-footer">
      <div class="message-timestamp">
        {{ formatTimestamp(message.timestamp) }}
      </div>
    </div>
  </div>

  <!-- System/AI Message Bubble -->
  <div *ngIf="!message.isUser" class="message-bubble system-bubble">
    <!-- Loading State -->
    <div *ngIf="message.isLoading" class="loading-content">
      <mat-spinner diameter="24"></mat-spinner>
      <span>AI is generating a response...</span>
    </div>
    
    <!-- Message Content with Formatting -->
    <div class="message-content" [innerHTML]="formattedContent"></div>
    
    <!-- Footer with Actions and Metadata (only for non-loading AI messages) -->
    <div *ngIf="!message.isLoading" class="message-footer">
      <!-- Left-aligned Action Buttons -->
      <div class="message-actions">
        <button mat-button class="text-icon-button" (click)="copyText()">
          <mat-icon>content_copy</mat-icon>
          <span>Copy</span>
        </button>
        
        <button mat-button class="text-icon-button" (click)="downloadText()">
          <mat-icon>download</mat-icon>
          <span>Download</span>
        </button>
        
        <button 
          mat-button 
          class="feedback-button" 
          (click)="provideFeedback()" 
          [disabled]="!message.requestId">
          Leave Feedback
        </button>
      </div>
      
      <!-- Right-aligned Metadata -->
      <div class="message-metadata">
        <div *ngIf="message.requestId" class="request-id">
          Request ID: {{ message.requestId }}
        </div>
        <div class="message-timestamp">
          {{ formatTimestamp(message.timestamp) }}
        </div>
      </div>
    </div>
  </div>
</div>